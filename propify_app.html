<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Propify Manager - App Edition</title>
    <!-- Iconos: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Supabase JS (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <style>
        /* --- DISEÑO ESTILO APP (Inventario Residencial) --- */
        :root {
            --primary: #1e293b;
            --primary-light: #334155;
            --accent: #4f46e5;
            --accent-hover: #4338ca;
            --background: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100vw;
        }

        /* --- Auth Overlay --- */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .auth-card {
            background: var(--card-bg);
            padding: 3rem 2rem;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        /* --- Sidebar (Escritorio) --- */
        #sidebar {
            width: 280px;
            background: var(--card-bg);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            z-index: 5000;
            flex-shrink: 0;
            height: 100vh;
            border-right: 1px solid var(--border);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center; 
            gap: 12px;
            color: var(--primary);
        }

        .nav-links {
            flex: 1;
            padding: 1rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 1rem;
            gap: 14px;
            text-decoration: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-item:hover { background: var(--background); color: var(--text-main); }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* --- Content Area --- */
        #main-content {
            flex: 1;
            padding: 2rem 3rem;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .mobile-header {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-main);
            padding: 0 1.25rem;
            height: 65px;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 3000;
            width: 100%;
            border-bottom: 1px solid var(--border);
        }

        /* --- Dashboard UI --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; width: 4px;
            background: var(--accent);
            border-radius: 4px 0 0 4px;
        }

        .stat-card h3 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .alerts-container { margin-bottom: 2rem; }
        .alert-item {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-left: 4px solid var(--warning);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            border-left-width: 4px;
        }

        /* --- Components --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .card-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            min-width: 600px;
        }

        th {
            background: #fafafa;
            padding: 1rem 1.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
            color: var(--text-main);
            vertical-align: middle;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        .badge {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 6000;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 24px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal h2 { margin-bottom: 1.5rem; color: var(--primary); font-size: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .form-control { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; background: var(--background); color: var(--text-main); }

        /* --- VISTA MÓVIL (Menú Inferior Nativo y Corrección de Scroll Horizontal) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-x: hidden; }
            
            /* Ocultar elementos del menú lateral que no van abajo */
            .sidebar-header, #sidebar > div:last-child {
                display: none !important;
            }
            
            /* Convertir Sidebar en Barra de Navegación Inferior */
            #sidebar { 
                position: fixed; 
                left: 0; 
                bottom: 0; 
                top: auto;
                height: 75px; 
                width: 100%;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--border);
                box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
                padding: 0;
            }
            
            .nav-links {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                padding: 0;
                width: 100%;
            }

            .nav-item {
                flex-direction: column;
                gap: 4px;
                padding: 8px 4px;
                font-size: 0.65rem;
                justify-content: center;
                border-radius: 8px;
                flex: 1;
                text-align: center;
            }

            .nav-item i { width: 22px; height: 22px; }
            .nav-item.active { background: transparent; color: var(--accent); box-shadow: none; font-weight: 800; }
            .nav-item.active i { color: var(--accent); fill: rgba(79, 70, 229, 0.1); }
            
            .mobile-header { display: flex; }
            
            /* Padding inferior para que el menú no tape el contenido */
            #main-content { padding: 1.5rem 1rem 90px 1rem; width: 100%; box-sizing: border-box; }
            
            .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .page-header .btn { width: 100%; }
            .header-actions { display: flex; width: 100%; gap: 10px; flex-wrap: wrap; }
            .header-actions .btn { flex: 1; justify-content: center; min-width: 100px; }

            .stats-grid { grid-template-columns: 1fr; gap: 1rem; }

            /* --- Transformar Tablas en Tarjetas (CORRECCIÓN SCROLL HORIZONTAL) --- */
            .table-container { overflow-x: hidden; } /* Prevenir scroll horizontal heredado */
            table { min-width: 100% !important; width: 100%; } /* Evitar que fuerce los 600px */
            table, thead, tbody, th, td, tr { display: block; width: 100%; box-sizing: border-box; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr { 
                background: white;
                border: 1px solid var(--border); 
                margin-bottom: 1rem; 
                border-radius: 16px; 
                padding: 1rem; 
                box-shadow: var(--shadow-sm);
            }
            
            td { 
                border: none; 
                padding: 0.6rem 0 !important; 
                display: flex; 
                align-items: center; 
                justify-content: space-between; 
                text-align: right; 
                border-bottom: 1px solid #f1f5f9;
                word-break: break-word;
                gap: 15px;
            }
            
            td:before { 
                content: attr(data-label); 
                font-weight: 600; 
                color: var(--text-muted); 
                font-size: 0.8rem; 
                text-transform: uppercase; 
                text-align: left; 
                flex-shrink: 0;
                max-width: 45%;
            }

            td:last-child { 
                border-bottom: none; 
                padding-top: 1rem !important; 
                margin-top: 0.5rem;
                justify-content: flex-end; 
                gap: 10px;
            }
            
            .modal { padding: 1.5rem; border-radius: 20px; }
        }

        .hidden { display: none !important; }
        section { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-card">
            <div style="width: 64px; height: 64px; background: #e0e7ff; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i data-lucide="building-2" style="width:32px; height:32px; color:var(--accent);"></i>
            </div>
            <h2 style="color:var(--primary); font-weight:800; font-size:1.5rem;">Propify</h2>
            <p style="margin-bottom: 2rem; color: var(--text-muted); font-size:0.9rem;">Gestión Residencial</p>

            <div id="auth-form-content">
                <input type="email" id="auth-email" class="form-control" placeholder="tu@email.com" style="margin-bottom: 1rem; text-align: center; font-size:1rem;">
                <input type="password" id="auth-password" class="form-control" placeholder="Contraseña" style="margin-bottom: 1.5rem; text-align: center; font-size:1rem;">
                <button id="auth-btn" class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="signIn()">
                    <i data-lucide="log-in"></i> Iniciar Sesión
                </button>
                <div style="margin-top: 1rem; text-align: center;">
                    <button id="reset-btn" class="btn btn-ghost" style="font-size:0.85rem; color:var(--text-muted); background:none; border:none; cursor:pointer; text-decoration:underline;" onclick="resetPassword()">
                        ¿Olvidaste tu contraseña?
                    </button>
                </div>
            </div>
            <div id="new-password-form-content" style="display:none;">
                <p style="margin-bottom:1rem; color:var(--text-muted); font-size:0.9rem;">Ingresa tu nueva contraseña.</p>
                <input type="password" id="new-password" class="form-control" placeholder="Nueva contraseña" style="margin-bottom: 1rem; text-align: center; font-size:1rem;">
                <input type="password" id="confirm-password" class="form-control" placeholder="Confirmar contraseña" style="margin-bottom: 1.5rem; text-align: center; font-size:1rem;">
                <button id="update-pwd-btn" class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="updatePassword()">
                    <i data-lucide="check"></i> Guardar Contraseña
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Header (Top Bar) -->
    <div class="mobile-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <i data-lucide="home" style="width:24px; color:var(--accent);"></i>
            <strong style="font-size: 1.2rem; letter-spacing: -0.5px;">Propify</strong>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <span id="user-email-display" style="font-size:0.75rem; color:var(--text-muted); max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>
            <button class="btn btn-ghost" style="padding: 8px; border:none;" onclick="exportDataJSON()" title="Descargar Backup"><i data-lucide="download"></i></button>
            <button class="btn btn-ghost" style="padding: 8px; border:none; color:var(--danger);" onclick="logout()" title="Cerrar Sesión"><i data-lucide="log-out"></i></button>
        </div>
    </div>

    <!-- Sidebar / Bottom Nav en Móvil -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <div style="background: var(--accent); padding: 8px; border-radius: 10px; display:flex;">
                <i data-lucide="home" style="color:white; width: 20px; height: 20px;"></i>
            </div>
            Propify
        </div>
        <nav class="nav-links">
            <a class="nav-item active" onclick="navigate('dashboard')"><i data-lucide="layout-grid"></i> <span>Dashboard</span></a>
            <a class="nav-item owner-only" onclick="navigate('tenants')"><i data-lucide="users"></i> <span>Inquilinos</span></a>
            <a class="nav-item owner-only" onclick="navigate('payments')"><i data-lucide="wallet"></i> <span>Recaudos</span></a>
            <a class="nav-item" onclick="navigate('services')"><i data-lucide="zap"></i> <span>Servicios</span></a>
            <a class="nav-item" onclick="navigate('adminfees')"><i data-lucide="building"></i> <span>Admin</span></a>
            <a class="nav-item owner-only" onclick="navigate('users')"><i data-lucide="shield"></i> <span>Usuarios</span></a>
        </nav>
        <div style="padding: 1.5rem; border-top: 1px solid var(--border);">
            <div id="sidebar-user-email" style="font-size:0.8rem; color:var(--text-muted); margin-bottom:12px; word-break:break-all;"></div>
            <button class="btn btn-ghost" onclick="exportDataJSON()" style="width: 100%; margin-bottom: 10px; justify-content:center;">
                <i data-lucide="download" style="width:16px;"></i> Backup Data
            </button>
            <button class="btn btn-ghost" onclick="logout()" style="width: 100%; color: var(--danger); justify-content:center;">
                <i data-lucide="log-out" style="width:16px;"></i> Salir
            </button>
        </div>
    </aside>

    <main id="main-content">
        <!-- Dashboard Section -->
        <section id="view-dashboard">
            <div class="page-header">
                <h1>Resumen de Gestión</h1>
            </div>

            <div id="dashboard-alerts" class="alerts-container"></div>

            <div class="stats-grid">
                <div class="stat-card"><h3>Total Inquilinos</h3><div class="value" id="stat-tenants">0</div></div>
                <div class="stat-card" style="border-left-color: var(--success);"><h3>Recaudado Mes</h3><div class="value" id="stat-monthly">0</div></div>
                <div class="stat-card" style="border-left-color: var(--danger);"><h3>Mora Inquilinos</h3><div class="value" id="stat-debt">0</div></div>
                
                <!-- Tarjeta Admin Modificada -->
                <div class="stat-card" style="border-left-color: var(--warning);">
                    <h3 id="admin-stat-title">Admin Pagada (Año)</h3>
                    <div class="value" id="stat-admin-count">0/12</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;" id="stat-admin-debt">Deuda: $0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Últimos Movimientos</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha Registro</th><th>Inquilino</th><th>Concepto</th><th>Monto</th><th>Acciones</th></tr></thead>
                        <tbody id="recent-payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tenants Section -->
        <section id="view-tenants" class="hidden">
            <div class="page-header">
                <h1>Directorio de Inquilinos</h1>
                <button class="btn btn-primary" onclick="openTenantModal()"><i data-lucide="plus"></i> Nuevo Inquilino</button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Nombre</th><th>WhatsApp</th><th>Canon</th><th>Vencimiento</th><th>Acciones</th></tr></thead>
                        <tbody id="tenants-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payments Section -->
        <section id="view-payments" class="hidden">
            <div class="page-header">
                <h1>Pagos Recibidos</h1>
                <button class="btn btn-success" onclick="openPaymentModal()"><i data-lucide="plus"></i> Registrar Abono</button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha Registro</th><th>Inquilino</th><th>Concepto</th><th>Monto</th><th>Mes Aplicado</th><th>Acciones</th></tr></thead>
                        <tbody id="payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section id="view-services" class="hidden">
            <div class="page-header">
                <h1>Gestión de Servicios</h1>
                <div class="header-actions">
                    <button class="btn btn-primary owner-only" onclick="openUtilityModal()"><i data-lucide="plus-circle"></i> Maestro</button>
                    <button class="btn btn-ghost owner-only" onclick="openReadingModal()"><i data-lucide="file-digit"></i> Lectura</button>
                    <button class="btn btn-success" onclick="openServicePaymentModal()"><i data-lucide="credit-card"></i> Cobrar Inq.</button>
                </div>
            </div>

            <div class="card owner-only">
                <div class="card-header"><h2>Cuentas Maestras</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Servicio</th><th>NIC / Contrato</th><th>Vencimiento</th><th>Acciones</th></tr></thead>
                        <tbody id="utility-accounts-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card owner-only">
                <div class="card-header"><h2>Registro de Medidores</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha</th><th>Servicio</th><th>Inquilino</th><th>Lectura</th><th>Acciones</th></tr></thead>
                        <tbody id="services-readings-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><h2>Pagos de Servicios (Inquilinos)</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha</th><th>Servicio</th><th>Inquilino</th><th>Monto</th><th>Mes/Año</th><th>Acciones</th></tr></thead>
                        <tbody id="services-payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="view-users" class="hidden">
            <div class="page-header">
                <h1>Gestión de Usuarios</h1>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead>
                        <tbody id="users-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Admin Fees Section -->
        <section id="view-adminfees" class="hidden">
            <div class="page-header">
                <h1>Administración</h1>
                <div class="header-actions">
                    <button class="btn btn-success owner-only" onclick="openGenerateYearModal()"><i data-lucide="calendar-plus"></i> Generar Año</button>
                    <button class="btn btn-primary owner-only" onclick="openAdminModal()"><i data-lucide="plus"></i> Registro Manual</button>
                </div>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Registro</th><th>Mes/Año</th><th>Valor</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody id="adminfees-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="tenant-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="t-modal-title">Ficha del Inquilino</h2>
            <form id="tenant-form" onsubmit="handleTenantSubmit(event)">
                <input type="hidden" id="t-id-hidden">
                <div class="form-group"><label>Nombre Completo</label><input type="text" id="t-name" class="form-control" required></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group"><label>WhatsApp</label><input type="tel" id="t-phone" class="form-control"></div>
                    <div class="form-group"><label>Día de Pago</label><input type="number" id="t-payday" class="form-control" min="1" max="31"></div>
                </div>
                <div class="form-group"><label>Canon Mensual ($)</label><input type="number" id="t-rent" class="form-control" required></div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group"><label>Inicio Contrato</label><input type="date" id="t-start" class="form-control" required></div>
                    <div class="form-group"><label>Fin Contrato</label><input type="date" id="t-end" class="form-control" required></div>
                </div>

                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PAGO DE INQUILINOS CON CAMPO CONCEPTO RESTAURADO -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="p-modal-title">Registrar Abono</h2>
            <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
                <div class="form-group"><label>Inquilino</label><select id="p-tenant" class="form-control" required></select></div>
                
                <div class="form-group">
                    <label>Concepto</label>
                    <select id="p-concept" class="form-control" required>
                        <option value="Arriendo Mensual">Arriendo Mensual</option>
                        <option value="Fracción">Fracción</option>
                        <option value="Depósito">Depósito</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group"><label>Monto Pagado ($)</label><input type="number" id="p-amount" class="form-control" required></div>
                <div class="form-group"><label>Mes a aplicar</label><input type="month" id="p-month" class="form-control" required></div>
                <div class="form-group"><label>Soporte (Foto/PDF)</label><input type="file" id="p-file" class="form-control" accept="image/*,application/pdf" style="padding: 10px;"></div>
                
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex:1; padding: 14px;">Guardar Abono</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="utility-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="u-modal-title">Cuenta Maestra</h2>
            <form id="utility-form" onsubmit="handleUtilitySubmit(event)">
                <input type="hidden" id="u-id-hidden">
                <div class="form-group"><label>Empresa Proveedora</label><select id="u-type" class="form-control"><option>Afinia</option><option>Surtigas</option><option>Aguas de Cartagena</option></select></div>
                <div class="form-group"><label>NIC / Contrato</label><input type="text" id="u-contract" class="form-control" required></div>
                <div class="form-group"><label>Día de Vencimiento</label><input type="text" id="u-due-date" class="form-control" placeholder="Ej: 04 de cada mes"></div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Cuenta</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reading-modal" class="modal-overlay">
        <div class="modal">
            <h2>Registrar Lectura</h2>
            <form id="reading-form" onsubmit="handleReadingSubmit(event)">
                <div class="form-group"><label>Inquilino</label><select id="r-tenant" class="form-control" required></select></div>
                <div class="form-group"><label>Servicio</label><select id="r-type" class="form-control"><option>Luz</option><option>Agua</option><option>Gas</option></select></div>
                <div class="form-group"><label>Lectura Actual (Números)</label><input type="number" id="r-meter" class="form-control" required step="any"></div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Lectura</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="service-payment-modal" class="modal-overlay">
        <div class="modal">
            <h2>Cobrar Servicio</h2>
            <form id="service-payment-form" onsubmit="handleServicePaymentSubmit(event)">
                <div class="form-group"><label>Inquilino</label><select id="sp-tenant" class="form-control" required></select></div>
                <div class="form-group"><label>Servicio Facturado</label><select id="sp-type" class="form-control"><option>Luz</option><option>Agua</option><option>Gas</option></select></div>
                <div class="form-group"><label>Monto a Cobrar ($)</label><input type="number" id="sp-amount" class="form-control" required></div>
                <div class="form-group"><label>Mes Correspondiente</label><input type="month" id="sp-month" class="form-control" required></div>
                <div class="form-group"><label>Soporte (Foto/PDF)</label><input type="file" id="sp-support" class="form-control" accept="image/*,application/pdf" style="padding: 10px;"></div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex:1; padding: 14px;">Guardar Cobro</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay">
        <div class="modal">
            <h2>Cuota Administración</h2>
            <form id="admin-form" onsubmit="handleAdminSubmit(event)">
                <input type="hidden" id="a-id-hidden">
                <div class="form-group"><label>Mes/Año</label><input type="month" id="a-month" class="form-control" required></div>
                <div class="form-group"><label>Monto ($)</label><input type="number" id="a-amount" class="form-control" required></div>
                <div class="form-group"><label>Estado</label>
                    <select id="a-status" class="form-control">
                        <option value="Pagado">Pagado</option>
                        <option value="Pendiente">Pendiente</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Estado</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewer-modal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                <h3 style="margin:0; font-size:1.2rem;">Soporte</h3>
                <button type="button" class="btn btn-ghost" onclick="closeModals()" style="padding: 8px; border:none;"><i data-lucide="x"></i></button>
            </div>
            <div style="text-align:center; min-height: 250px; background:var(--background); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; border: 1px solid var(--border); gap:12px; padding:8px;">
                <img id="viewer-img" src="" style="max-width:100%; max-height: 60vh; display:none; border-radius: 12px;">
                <embed id="viewer-pdf" src="" type="application/pdf" style="width:100%; height: 60vh; display:none; border-radius: 8px;">
                <a id="viewer-pdf-link" href="" target="_blank" rel="noopener" class="btn btn-primary" style="display:none;">
                    <i data-lucide="external-link"></i> Abrir PDF
                </a>
                <div id="viewer-empty" style="color: var(--text-muted); display:flex; flex-direction:column; align-items:center; gap:10px;">
                    <i data-lucide="image-off" style="width:32px; height:32px;"></i>
                    <p>Sin soporte adjunto.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Role Modal -->
    <div id="user-role-modal" class="modal-overlay">
        <div class="modal">
            <h2>Cambiar Rol de Usuario</h2>
            <form id="user-role-form" onsubmit="handleUserRoleSubmit(event)">
                <input type="hidden" id="ur-id-hidden">
                <div class="form-group"><label>Email</label><input type="text" id="ur-email" class="form-control" readonly style="background:#f1f5f9;"></div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="ur-role" class="form-control">
                        <option value="tenant">Inquilino (tenant)</option>
                        <option value="owner">Propietario (owner)</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Rol</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generate Year Fees Modal -->
    <div id="generate-year-modal" class="modal-overlay">
        <div class="modal">
            <h2>Generar Cuotas del Año</h2>
            <form id="generate-year-form" onsubmit="handleGenerateYear(event)">
                <div class="form-group"><label>Año</label><input type="number" id="gy-year" class="form-control" required></div>
                <div class="form-group"><label>Monto Mensual ($)</label><input type="number" id="gy-amount" class="form-control" required></div>
                <p style="font-size:0.85rem; color:var(--text-muted); margin-top:-0.5rem; margin-bottom:1rem;">Solo se crearán los meses que aún no existan.</p>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex:1; padding: 14px;">Generar Cuotas</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 7000;">
        <div class="modal" style="max-width: 350px; text-align: center; padding: 2.5rem 1.5rem;">
            <div style="width: 64px; height: 64px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i data-lucide="alert-triangle" style="width:32px; height:32px; color:var(--danger);"></i>
            </div>
            <h3 style="font-size: 1.3rem;">¿Estás seguro?</h3>
            <p id="confirm-text" style="margin: 0.8rem 0 2rem; color: var(--text-muted); font-size: 0.95rem;">Esta acción no se puede deshacer.</p>
            <div style="display: flex; gap: 10px;">
                <button id="confirm-yes" class="btn btn-danger" style="flex: 1; padding: 14px;">Eliminar</button>
                <button onclick="closeConfirm()" class="btn btn-ghost" style="flex: 1; padding: 14px;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // 1. SUPABASE CONFIGURATION
        // Replace these placeholder values with your actual Supabase project credentials.
        // See README.md for full setup instructions.
        // =====================================================
        const SUPABASE_URL = 'https://inkzbetwxxdvxobvuuib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlua3piZXR3eHhkdnhvYnZ1dWliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDIwNzIsImV4cCI6MjA4NzM3ODA3Mn0.DHlooMJo4rwEsyXoDgeFkCSAH6oyLvLDUZYXYgVEc6E';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // =====================================================
        // 2. APP STATE
        // =====================================================
        let state = { tenants: [], payments: [], services: [], servicePayments: [], adminfees: [], utilityAccounts: [], profiles: [] };
        let currentUser = null;
        let currentRole = null; // 'owner' | 'tenant'

        // HTML-escape helper to prevent XSS when injecting user data into innerHTML
        function esc(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // =====================================================
        // 3. AUTH FUNCTIONS
        // =====================================================
        async function signIn() {
            if (!SUPABASE_URL || !SUPABASE_URL.startsWith('https://')) {
                alert('Configura SUPABASE_URL y SUPABASE_ANON_KEY en el archivo. Ver README.md para instrucciones.');
                return;
            }
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            if (!email) { alert('Por favor ingresa tu email.'); return; }
            if (!password) { alert('Por favor ingresa tu contraseña.'); return; }
            const btn = document.getElementById('auth-btn');
            btn.disabled = true;
            btn.textContent = 'Ingresando...';
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="log-in"></i> Iniciar Sesión';
            lucide.createIcons();
            if (error) {
                alert('Error: ' + error.message);
            }
        }

        function logout() {
            supabaseClient.auth.signOut();
        }

        async function resetPassword() {
            const email = document.getElementById('auth-email').value.trim();
            if (!email) { alert('Por favor ingresa tu email para restablecer la contraseña.'); return; }
            const btn = document.getElementById('reset-btn');
            btn.disabled = true;
            btn.textContent = 'Enviando...';
            const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.href
            });
            btn.disabled = false;
            btn.textContent = '¿Olvidaste tu contraseña?';
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Te enviamos un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.');
            }
        }

        async function updatePassword() {
            const newPwd = document.getElementById('new-password').value;
            const confirmPwd = document.getElementById('confirm-password').value;
            if (!newPwd) { alert('Por favor ingresa una nueva contraseña.'); return; }
            if (newPwd.length < 6) { alert('La contraseña debe tener al menos 6 caracteres.'); return; }
            if (newPwd !== confirmPwd) { alert('Las contraseñas no coinciden.'); return; }
            const btn = document.getElementById('update-pwd-btn');
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            const { error } = await supabaseClient.auth.updateUser({ password: newPwd });
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="check"></i> Guardar Contraseña';
            lucide.createIcons();
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Contraseña actualizada correctamente. Ya puedes iniciar sesión.');
                document.getElementById('new-password-form-content').style.display = 'none';
                document.getElementById('auth-form-content').style.display = 'block';
                await supabaseClient.auth.signOut();
            }
        }

        async function getUserRole(userId) {
            const { data } = await supabaseClient.from('profiles').select('role').eq('id', userId).single();
            return data?.role || 'tenant';
        }

        function applyRoleUI(role) {
            const isOwner = role === 'owner';
            document.querySelectorAll('.owner-only').forEach(el => el.classList.toggle('hidden', !isOwner));
        }

        // =====================================================
        // 4. SUPABASE DATA LAYER
        // =====================================================
        async function fetchStateFromSupabase() {
            const [tenantsRes, paymentsRes, readingsRes, spRes, feesRes, uaRes, profilesRes] = await Promise.all([
                supabaseClient.from('tenants').select('*'),
                supabaseClient.from('payments').select('*').order('created_at', { ascending: false }),
                supabaseClient.from('service_readings').select('*').order('created_at', { ascending: false }),
                supabaseClient.from('service_payments').select('*').order('created_at', { ascending: false }),
                supabaseClient.from('admin_fees').select('*').order('month', { ascending: false }),
                supabaseClient.from('utility_accounts').select('*'),
                supabaseClient.from('profiles').select('*'),
            ]);
            return {
                tenants: (tenantsRes.data || []).map(t => ({
                    id: t.id, name: t.name, phone: t.phone, payday: t.payday,
                    rent: t.rent, start: t.start_date, end: t.end_date
                })),
                payments: (paymentsRes.data || []).map(p => ({
                    id: p.id, tenantId: p.tenant_id, concept: p.concept,
                    amount: p.amount, month: p.month,
                    receipt: p.receipt_url, receiptType: p.receipt_type,
                    createdAt: p.created_at
                })),
                services: (readingsRes.data || []).map(r => ({
                    id: r.id, tenantId: r.tenant_id, type: r.type,
                    meterReading: r.meter_reading, date: r.date
                })),
                servicePayments: (spRes.data || []).map(sp => ({
                    id: sp.id, tenantId: sp.tenant_id, type: sp.type,
                    amount: sp.amount, month: sp.month, date: sp.date,
                    supportUrl: sp.support_url, supportType: sp.support_type
                })),
                adminfees: (feesRes.data || []).map(af => ({
                    id: af.id, month: af.month, amount: af.amount,
                    status: af.status, createdAt: af.created_at
                })),
                utilityAccounts: (uaRes.data || []).map(ua => ({
                    id: ua.id, type: ua.type, contract: ua.contract,
                    dueDate: ua.due_date, lastPaidMonth: ua.last_paid_month
                })),
                profiles: (profilesRes.data || []).map(pr => ({
                    id: pr.id, email: pr.email, role: pr.role
                }))
            };
        }

        async function uploadSupportToStorage(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const path = `${Date.now()}-${Math.random().toString(36).substring(2, 11)}.${ext}`;
            const { error } = await supabaseClient.storage
                .from('supports')
                .upload(path, file, { cacheControl: '3600', upsert: false });
            if (error) throw error;
            const { data: { publicUrl } } = supabaseClient.storage.from('supports').getPublicUrl(path);
            return { url: publicUrl, type: file.type.startsWith('image/') ? 'image' : 'pdf' };
        }

        async function saveAdminFeeToSupabase(data) {
            if (data.id) {
                const { error } = await supabaseClient.from('admin_fees')
                    .update({ amount: parseFloat(data.amount), status: data.status })
                    .eq('id', data.id);
                if (error) throw error;
            } else {
                const { error } = await supabaseClient.from('admin_fees')
                    .insert({ month: data.month, amount: parseFloat(data.amount), status: data.status });
                if (error) throw error;
            }
        }

        async function saveServicePaymentToSupabase(data) {
            const { error } = await supabaseClient.from('service_payments').insert({
                tenant_id: data.tenantId,
                type: data.type,
                amount: parseFloat(data.amount),
                month: data.month,
                support_url: data.supportUrl || null,
                support_type: data.supportType || null
            });
            if (error) throw error;
        }

        async function ensureCurrentYearAdminFees() {
            const year = new Date().getFullYear();
            const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            const existing = state.adminfees.map(af => af.month);
            const missing = months.map(m => `${year}-${m}`).filter(k => !existing.includes(k));
            if (missing.length > 0) {
                await supabaseClient.from('admin_fees').insert(
                    missing.map(month => ({ month, amount: 204800, status: 'Pendiente' }))
                );
            }
        }

        // =====================================================
        // 5. SYNC
        // =====================================================
        async function sync() {
            try {
                state = await fetchStateFromSupabase();
                if (currentRole === 'owner') {
                    await ensureCurrentYearAdminFees();
                    // Re-fetch admin fees after potential creation
                    const { data } = await supabaseClient.from('admin_fees').select('*').order('month', { ascending: false });
                    state.adminfees = (data || []).map(af => ({
                        id: af.id, month: af.month, amount: af.amount,
                        status: af.status, createdAt: af.created_at
                    }));
                }
            } catch (e) {
                console.error('Sync error:', e);
            }
            renderAll();
        }

        // =====================================================
        // 6. EXPORT
        // =====================================================
        function exportDataJSON() {
            const fileName = `propify_backup_${new Date().toISOString().split('T')[0]}.json`;
            const json = JSON.stringify(state, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // =====================================================
        // 7. NAVIGATION & MODALS
        // =====================================================
        function navigate(view) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (event) event.currentTarget.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => { if (m.id !== 'confirm-modal') m.style.display = 'none'; });
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; }

        // =====================================================
        // 8. RENDER FUNCTIONS
        // =====================================================
        function renderAll() {
            renderDashboard();
            renderTenants();
            renderPayments();
            renderAdminFees();
            renderServices();
            renderUsers();
            lucide.createIcons();
        }

        function renderDashboard() {
            const now = new Date();
            const currMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const nombreMes = meses[now.getMonth()];
            const alertsDiv = document.getElementById('dashboard-alerts');
            const alerts = [];

            const curAdmin = state.adminfees.find(af => af.month === currMonthStr);
            if (curAdmin && curAdmin.status === 'Pendiente') {
                alerts.push({
                    type: 'warning',
                    title: 'Administración Pendiente',
                    text: `Cuota de ${currMonthStr}. <br><strong>Valor a pagar: $${parseFloat(curAdmin.amount).toLocaleString()}</strong>`
                });
            }

            const yearStr = now.getFullYear().toString();
            const adminThisYear = state.adminfees.filter(af => af.month.startsWith(`${yearStr}-`));
            const adminPaidCount = adminThisYear.filter(af => af.status === 'Pagado').length;
            const admDeud = adminThisYear.filter(af => af.status === 'Pendiente').reduce((s, af) => s + parseFloat(af.amount), 0);
            document.getElementById('admin-stat-title').innerText = `Admin Pagada (${yearStr})`;
            document.getElementById('stat-admin-count').innerText = `${adminPaidCount}/12`;
            document.getElementById('stat-admin-debt').innerText = `Deuda: $${admDeud.toLocaleString()}`;

            let totalMoraInquilinos = 0;
            state.tenants.forEach(t => {
                // 4.1 Contract expiring in ≤ 30 days
                if (t.end) {
                    const endDate = new Date(t.end + 'T00:00:00');
                    const diffDays = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                    if (diffDays > 0 && diffDays <= 30) {
                        const waContrato = `Estimado/a ${t.name}, le informamos que su contrato de arrendamiento vence el ${t.end} (en ${diffDays} día${diffDays === 1 ? '' : 's'}). Por favor tome las medidas necesarias.`;
                        alerts.push({
                            type: 'warning',
                            title: `Contrato por vencer: ${esc(t.name)}`,
                            text: `Faltan <strong>${diffDays} día${diffDays === 1 ? '' : 's'}</strong> para el fin del contrato (${esc(t.end)}).`,
                            phone: t.phone, waMsg: waContrato
                        });
                    }
                }

                let expectedRent = parseFloat(t.rent);
                let isFraction = false; let daysToCharge = 30;
                if (t.start && t.start.startsWith(currMonthStr)) {
                    const startDay = parseInt(t.start.split('-')[2]);
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    daysToCharge = daysInMonth - startDay + 1;
                    if (daysToCharge > 0 && daysToCharge < daysInMonth) {
                        isFraction = true;
                        expectedRent = Math.round((parseFloat(t.rent) / 30) * daysToCharge);
                    }
                }
                const paidRent = state.payments
                    .filter(p => p.tenantId === t.id && p.month === currMonthStr && (!p.concept || p.concept === 'Arriendo Mensual' || p.concept === 'Fracción'))
                    .reduce((s, p) => s + parseFloat(p.amount), 0);
                const debt = expectedRent - paidRent;
                if (debt > 0) totalMoraInquilinos += debt;

                // 4.2 Monthly rent reminder on the 1st of each month
                if (now.getDate() === 1 && debt > 0) {
                    const waReminder = `Estimado/a ${t.name}, le recordamos que hoy es el 1° del mes y corresponde el pago del canon de arrendamiento por valor de $${expectedRent.toLocaleString()} correspondiente a ${nombreMes}. Gracias.`;
                    alerts.push({
                        type: 'warning',
                        title: `Recordatorio de pago: ${esc(t.name)}`,
                        text: `Canon de ${nombreMes}: <strong>$${expectedRent.toLocaleString()}</strong>`,
                        phone: t.phone, waMsg: waReminder
                    });
                }

                // 4.3 Overdue after 5th of month (or after payday)
                if (debt > 0 && now.getDate() > (parseInt(t.payday) || 5)) {
                    const concepto = isFraction ? 'fracción de arrendamiento' : 'arrendamiento';
                    const msgWaMora = `ATENCIÓN "${t.name.toUpperCase()}": Se notifica advertencia de incumplimiento de pago por concepto de ${concepto} correspondiente al mes "${nombreMes}" por un valor de "$${debt.toLocaleString()}". Por favor regularizar de inmediato.`;
                    alerts.push({
                        type: 'danger',
                        title: isFraction ? `Fracción Pendiente: ${esc(t.name)}` : `Mora de Arriendo: ${esc(t.name)}`,
                        text: `Valor a pagar: <strong>$${debt.toLocaleString()}</strong>`,
                        phone: t.phone, waMsg: msgWaMora
                    });
                }
            });

            alertsDiv.innerHTML = alerts.map(a => `
                <div class="alert-item alert-${esc(a.type)}">
                    <div style="flex:1;"><h4 style="margin-bottom:6px;">${a.title}</h4><p>${a.text}</p></div>
                    ${a.waMsg ? `<button class="btn btn-whatsapp" data-phone="${esc(a.phone||'')}" data-msg="${esc(a.waMsg)}" onclick="sendWA(this.dataset.phone,this.dataset.msg)"><i data-lucide="message-circle"></i></button>` : ''}
                </div>`).join('');

            document.getElementById('stat-tenants').innerText = state.tenants.length;
            const mesColl = state.payments.filter(p => p.month === currMonthStr).reduce((s, p) => s + parseFloat(p.amount), 0);
            document.getElementById('stat-monthly').innerText = `$${mesColl.toLocaleString()}`;
            document.getElementById('stat-debt').innerText = `$${totalMoraInquilinos.toLocaleString()}`;

            document.getElementById('recent-payments-tbody').innerHTML = [...state.payments]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5)
                .map(p => {
                    const t = state.tenants.find(x => x.id === p.tenantId);
                    return `<tr>
                        <td data-label="Fecha Registro">${new Date(p.createdAt).toLocaleDateString()}</td>
                        <td data-label="Inquilino">${esc(t?.name)}</td>
                        <td data-label="Concepto">${esc(p.concept) || '-'}</td>
                        <td data-label="Monto">$${parseFloat(p.amount).toLocaleString()}</td>
                        <td data-label="Acciones">${p.receipt ? `<button class="btn btn-ghost" onclick="viewReceipt('${esc(p.id)}')"><i data-lucide="paperclip"></i></button>` : ''}</td>
                    </tr>`;
                }).join('');
        }

        function renderTenants() {
            document.getElementById('tenants-tbody').innerHTML = state.tenants.map(t => `
                <tr>
                    <td data-label="Nombre"><strong>${esc(t.name)}</strong></td>
                    <td data-label="WhatsApp">${esc(t.phone) || '-'}</td>
                    <td data-label="Canon">$${parseFloat(t.rent).toLocaleString()}</td>
                    <td data-label="Vencimiento">${esc(t.end) || '-'}</td>
                    <td data-label="Acciones">
                        <button class="btn btn-ghost" onclick="openTenantModal('${esc(t.id)}')"><i data-lucide="edit-3"></i></button>
                        <button class="btn btn-ghost" onclick="askDeleteTenant('${esc(t.id)}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>`).join('');
        }

        function renderPayments() {
            document.getElementById('payments-tbody').innerHTML = state.payments.map(p => {
                const t = state.tenants.find(x => x.id === p.tenantId);
                return `<tr>
                    <td data-label="Fecha Registro">${new Date(p.createdAt).toLocaleDateString()}</td>
                    <td data-label="Inquilino">${esc(t?.name)}</td>
                    <td data-label="Concepto">${esc(p.concept) || '-'}</td>
                    <td data-label="Monto">$${parseFloat(p.amount).toLocaleString()}</td>
                    <td data-label="Mes Aplicado">${esc(p.month)}</td>
                    <td data-label="Acciones">
                        ${p.receipt ? `<button class="btn btn-ghost" onclick="viewReceipt('${esc(p.id)}')"><i data-lucide="paperclip"></i></button>` : ''}
                        <button class="btn btn-ghost" onclick="askDeletePayment('${esc(p.id)}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderAdminFees() {
            document.getElementById('adminfees-tbody').innerHTML = [...state.adminfees]
                .sort((a, b) => b.month.localeCompare(a.month))
                .map(af => `
                <tr>
                    <td data-label="Registro">${af.createdAt ? new Date(af.createdAt).toLocaleDateString() : '-'}</td>
                    <td data-label="Mes/Año">${esc(af.month)}</td>
                    <td data-label="Valor">$${parseFloat(af.amount).toLocaleString()}</td>
                    <td data-label="Estado"><span class="badge ${af.status === 'Pagado' ? 'badge-success' : 'badge-danger'}">${esc(af.status)}</span></td>
                    <td data-label="Acciones">
                        ${currentRole === 'owner' ? `<button class="btn btn-ghost" onclick="openAdminModal('${esc(af.id)}')"><i data-lucide="edit-3"></i></button>` : ''}
                    </td>
                </tr>`).join('');
        }

        function renderServices() {
            document.getElementById('utility-accounts-tbody').innerHTML = state.utilityAccounts.map(u => `
                <tr>
                    <td data-label="Servicio"><strong>${esc(u.type)}</strong></td>
                    <td data-label="NIC / Contrato">${esc(u.contract)}</td>
                    <td data-label="Vencimiento">${esc(u.dueDate) || '-'}</td>
                    <td data-label="Acciones">
                        <button class="btn btn-ghost" onclick="openUtilityModal('${esc(u.id)}')"><i data-lucide="edit-3"></i></button>
                        <button class="btn btn-ghost" onclick="askDeleteUtility('${esc(u.id)}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>`).join('');

            document.getElementById('services-readings-tbody').innerHTML = state.services.map(r => {
                const t = state.tenants.find(x => x.id === r.tenantId);
                return `<tr>
                    <td data-label="Fecha">${esc(r.date) || '-'}</td>
                    <td data-label="Servicio">${esc(r.type)}</td>
                    <td data-label="Inquilino">${esc(t?.name)}</td>
                    <td data-label="Lectura">${esc(r.meterReading)}</td>
                    <td data-label="Acciones">
                        <button class="btn btn-ghost" onclick="askDeleteReading('${esc(r.id)}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('services-payments-tbody').innerHTML = state.servicePayments.map(sp => {
                const t = state.tenants.find(x => x.id === sp.tenantId);
                const supportBtn = sp.supportUrl
                    ? `<button class="btn btn-ghost" onclick="viewServiceSupport('${esc(sp.id)}')"><i data-lucide="paperclip"></i></button>`
                    : '';
                const deleteBtn = currentRole === 'owner'
                    ? `<button class="btn btn-ghost" onclick="askDeleteServicePayment('${esc(sp.id)}')"><i data-lucide="trash-2"></i></button>`
                    : '';
                return `<tr>
                    <td data-label="Fecha">${esc(sp.date) || '-'}</td>
                    <td data-label="Servicio">${esc(sp.type)}</td>
                    <td data-label="Inquilino">${esc(t?.name)}</td>
                    <td data-label="Monto">$${parseFloat(sp.amount).toLocaleString()}</td>
                    <td data-label="Mes/Año">${esc(sp.month)}</td>
                    <td data-label="Acciones">${supportBtn} ${deleteBtn}</td>
                </tr>`;
            }).join('');
        }

        // =====================================================
        // 9. FORM HANDLERS
        // =====================================================
        function renderUsers() {
            const tbody = document.getElementById('users-tbody');
            if (!tbody) return;
            tbody.innerHTML = state.profiles.map(pr => `
                <tr>
                    <td data-label="Email">${esc(pr.email)}</td>
                    <td data-label="Rol"><span class="badge ${pr.role === 'owner' ? 'badge-success' : 'badge-danger'}">${esc(pr.role)}</span></td>
                    <td data-label="Acciones">
                        <button class="btn btn-ghost" onclick="openUserRoleModal('${esc(pr.id)}')"><i data-lucide="edit-3"></i></button>
                    </td>
                </tr>`).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);">Sin usuarios registrados</td></tr>';
        }

        async function handleTenantSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('t-id-hidden').value;
            const data = {
                name: document.getElementById('t-name').value,
                phone: document.getElementById('t-phone').value,
                payday: parseInt(document.getElementById('t-payday').value) || null,
                rent: parseFloat(document.getElementById('t-rent').value),
                start_date: document.getElementById('t-start').value,
                end_date: document.getElementById('t-end').value || null
            };
            let err;
            if (id) { ({ error: err } = await supabaseClient.from('tenants').update(data).eq('id', id)); }
            else { ({ error: err } = await supabaseClient.from('tenants').insert(data)); }
            if (err) { alert('Error: ' + err.message); return; }
            closeModals(); await sync();
        }

        async function handlePaymentSubmit(e) {
            e.preventDefault();
            const file = document.getElementById('p-file').files[0];
            let receiptUrl = null, receiptType = null;
            if (file) {
                try {
                    const r = await uploadSupportToStorage(file);
                    receiptUrl = r.url; receiptType = r.type;
                } catch (err) { alert('Error al subir soporte: ' + err.message); return; }
            }
            const { error } = await supabaseClient.from('payments').insert({
                tenant_id: document.getElementById('p-tenant').value,
                concept: document.getElementById('p-concept').value,
                amount: parseFloat(document.getElementById('p-amount').value),
                month: document.getElementById('p-month').value,
                receipt_url: receiptUrl,
                receipt_type: receiptType
            });
            if (error) { alert('Error: ' + error.message); return; }
            closeModals(); await sync();
        }

        async function handleAdminSubmit(e) {
            e.preventDefault();
            try {
                await saveAdminFeeToSupabase({
                    id: document.getElementById('a-id-hidden').value || null,
                    month: document.getElementById('a-month').value,
                    amount: document.getElementById('a-amount').value,
                    status: document.getElementById('a-status').value
                });
            } catch (err) { alert('Error: ' + err.message); return; }
            closeModals(); await sync();
        }

        async function handleServicePaymentSubmit(e) {
            e.preventDefault();
            const file = document.getElementById('sp-support').files[0];
            let supportUrl = null, supportType = null;
            if (file) {
                try {
                    const r = await uploadSupportToStorage(file);
                    supportUrl = r.url; supportType = r.type;
                } catch (err) { alert('Error al subir soporte: ' + err.message); return; }
            }
            try {
                await saveServicePaymentToSupabase({
                    tenantId: document.getElementById('sp-tenant').value,
                    type: document.getElementById('sp-type').value,
                    amount: document.getElementById('sp-amount').value,
                    month: document.getElementById('sp-month').value,
                    supportUrl, supportType
                });
            } catch (err) { alert('Error: ' + err.message); return; }
            closeModals(); await sync();
        }

        async function handleReadingSubmit(e) {
            e.preventDefault();
            const { error } = await supabaseClient.from('service_readings').insert({
                tenant_id: document.getElementById('r-tenant').value,
                type: document.getElementById('r-type').value,
                meter_reading: parseFloat(document.getElementById('r-meter').value)
            });
            if (error) { alert('Error: ' + error.message); return; }
            closeModals(); await sync();
        }

        async function handleUtilitySubmit(e) {
            e.preventDefault();
            const id = document.getElementById('u-id-hidden').value;
            const data = {
                type: document.getElementById('u-type').value,
                contract: document.getElementById('u-contract').value,
                due_date: document.getElementById('u-due-date').value
            };
            let err;
            if (id) { ({ error: err } = await supabaseClient.from('utility_accounts').update(data).eq('id', id)); }
            else { ({ error: err } = await supabaseClient.from('utility_accounts').insert(data)); }
            if (err) { alert('Error: ' + err.message); return; }
            closeModals(); await sync();
        }

        // =====================================================
        // 10. MODAL OPENERS
        // =====================================================
        function openTenantModal(id = null) {
            document.getElementById('tenant-form').reset();
            document.getElementById('t-id-hidden').value = id || '';
            if (id) {
                const t = state.tenants.find(x => x.id === id);
                if (t) {
                    document.getElementById('t-name').value = t.name || '';
                    document.getElementById('t-phone').value = t.phone || '';
                    document.getElementById('t-payday').value = t.payday || '';
                    document.getElementById('t-rent').value = t.rent || '';
                    document.getElementById('t-start').value = t.start || '';
                    document.getElementById('t-end').value = t.end || '';
                }
            }
            document.getElementById('tenant-modal').style.display = 'flex';
        }

        function openAdminModal(id = null) {
            document.getElementById('admin-form').reset();
            document.getElementById('a-id-hidden').value = id || '';
            if (id) {
                const af = state.adminfees.find(x => x.id === id);
                if (af) {
                    document.getElementById('a-month').value = af.month;
                    document.getElementById('a-amount').value = af.amount;
                    document.getElementById('a-status').value = af.status;
                }
            }
            document.getElementById('admin-modal').style.display = 'flex';
        }

        function openPaymentModal() {
            document.getElementById('payment-form').reset();
            document.getElementById('p-tenant').innerHTML = state.tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('payment-modal').style.display = 'flex';
        }

        function openUtilityModal(id = null) {
            document.getElementById('utility-form').reset();
            document.getElementById('u-id-hidden').value = id || '';
            if (id) {
                const u = state.utilityAccounts.find(x => x.id === id);
                if (u) {
                    document.getElementById('u-type').value = u.type;
                    document.getElementById('u-contract').value = u.contract;
                    document.getElementById('u-due-date').value = u.dueDate || '';
                }
            }
            document.getElementById('utility-modal').style.display = 'flex';
        }

        function openReadingModal() {
            document.getElementById('reading-form').reset();
            document.getElementById('r-tenant').innerHTML = state.tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('reading-modal').style.display = 'flex';
        }

        function openServicePaymentModal() {
            document.getElementById('service-payment-form').reset();
            document.getElementById('sp-tenant').innerHTML = state.tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('service-payment-modal').style.display = 'flex';
        }

        function openUserRoleModal(id) {
            const pr = state.profiles.find(x => x.id === id);
            if (!pr) return;
            document.getElementById('ur-id-hidden').value = pr.id;
            document.getElementById('ur-email').value = pr.email;
            document.getElementById('ur-role').value = pr.role;
            document.getElementById('user-role-modal').style.display = 'flex';
        }

        function openGenerateYearModal() {
            document.getElementById('generate-year-form').reset();
            document.getElementById('gy-year').value = new Date().getFullYear();
            document.getElementById('gy-amount').value = 204800;
            document.getElementById('generate-year-modal').style.display = 'flex';
        }

        async function handleUserRoleSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('ur-id-hidden').value;
            const role = document.getElementById('ur-role').value;
            const { error } = await supabaseClient.from('profiles').update({ role }).eq('id', id);
            if (error) { alert('Error: ' + error.message); return; }
            closeModals(); await sync();
        }

        async function handleGenerateYear(e) {
            e.preventDefault();
            const year = parseInt(document.getElementById('gy-year').value);
            const amount = parseFloat(document.getElementById('gy-amount').value);
            if (!year || !amount) return;
            const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
            const existing = state.adminfees.map(af => af.month);
            const missing = months.map(m => `${year}-${m}`).filter(k => !existing.includes(k));
            if (missing.length === 0) {
                alert(`Todos los meses de ${year} ya existen.`);
                return;
            }
            const { error } = await supabaseClient.from('admin_fees').insert(
                missing.map(month => ({ month, amount, status: 'Pendiente' }))
            );
            if (error) { alert('Error: ' + error.message); return; }
            closeModals(); await sync();
        }

        // =====================================================
        // 11. SUPPORT VIEWER (image + PDF)
        // =====================================================
        function viewSupport(url, type) {
            const img = document.getElementById('viewer-img');
            const pdf = document.getElementById('viewer-pdf');
            const pdfLink = document.getElementById('viewer-pdf-link');
            const emp = document.getElementById('viewer-empty');
            img.style.display = 'none'; pdf.style.display = 'none';
            pdfLink.style.display = 'none'; emp.style.display = 'none';
            if (url) {
                if (type === 'pdf') {
                    pdf.src = url; pdf.style.display = 'block';
                    pdfLink.href = url; pdfLink.style.display = 'inline-flex';
                } else {
                    img.src = url; img.style.display = 'block';
                }
            } else { emp.style.display = 'flex'; }
            document.getElementById('viewer-modal').style.display = 'flex';
        }

        function viewReceipt(pid) {
            const p = state.payments.find(x => x.id === pid);
            viewSupport(p?.receipt || null, p?.receiptType || 'image');
        }

        function viewServiceSupport(spid) {
            const sp = state.servicePayments.find(x => x.id === spid);
            viewSupport(sp?.supportUrl || null, sp?.supportType || 'image');
        }

        // =====================================================
        // 12. DELETE ACTIONS
        // =====================================================
        let deleteAction = null;

        function showConfirm(text, action) {
            document.getElementById('confirm-text').innerText = text;
            deleteAction = action;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        document.getElementById('confirm-yes').onclick = async () => {
            if (deleteAction) await deleteAction();
            deleteAction = null;
            closeConfirm();
        };

        function askDeleteTenant(id) { showConfirm('¿Eliminar inquilino?', async () => { await supabaseClient.from('tenants').delete().eq('id', id); await sync(); }); }
        function askDeletePayment(id) { showConfirm('¿Borrar pago?', async () => { await supabaseClient.from('payments').delete().eq('id', id); await sync(); }); }
        function askDeleteReading(id) { showConfirm('¿Borrar lectura?', async () => { await supabaseClient.from('service_readings').delete().eq('id', id); await sync(); }); }
        function askDeleteServicePayment(id) { showConfirm('¿Borrar pago de servicio?', async () => { await supabaseClient.from('service_payments').delete().eq('id', id); await sync(); }); }
        function askDeleteUtility(id) { showConfirm('¿Eliminar cuenta maestra?', async () => { await supabaseClient.from('utility_accounts').delete().eq('id', id); await sync(); }); }

        window.markUtilityPaid = async function(id, month) {
            await supabaseClient.from('utility_accounts').update({ last_paid_month: month }).eq('id', id);
            await sync();
        };

        // =====================================================
        // 13. UTILS
        // =====================================================
        function sendWA(phone, msg) {
            const url = phone ? `https://wa.me/${phone.replace(/\D/g, '')}` : 'https://wa.me/';
            window.open(`${url}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // =====================================================
        // 14. APP INIT
        // =====================================================
        window.onload = async () => {
            // Handle auth state changes
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'PASSWORD_RECOVERY') {
                    document.getElementById('auth-overlay').style.display = 'flex';
                    document.getElementById('auth-form-content').style.display = 'none';
                    document.getElementById('new-password-form-content').style.display = 'block';
                    lucide.createIcons();
                    return;
                }
                if (session?.user) {
                    currentUser = session.user;
                    currentRole = await getUserRole(session.user.id);
                    document.getElementById('auth-overlay').style.display = 'none';
                    const emailEl = document.getElementById('user-email-display');
                    const sidebarEmailEl = document.getElementById('sidebar-user-email');
                    if (emailEl) emailEl.textContent = session.user.email;
                    if (sidebarEmailEl) sidebarEmailEl.textContent = session.user.email;
                    applyRoleUI(currentRole);
                    await sync();
                } else {
                    currentUser = null;
                    currentRole = null;
                    document.getElementById('auth-overlay').style.display = 'flex';
                }
            });

            // Check for an existing active session on page load
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        };
    </script>
</body>
</html>
