<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Propify Manager - App Edition</title>
    <!-- Iconos: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- DISEÑO ESTILO APP (Inventario Residencial) --- */
        :root {
            --primary: #1e293b;
            --primary-light: #334155;
            --accent: #4f46e5;
            --accent-hover: #4338ca;
            --background: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100vw;
        }

        /* --- Auth Overlay --- */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .auth-card {
            background: var(--card-bg);
            padding: 3rem 2rem;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        /* --- Sidebar (Escritorio) --- */
        #sidebar {
            width: 280px;
            background: var(--card-bg);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            z-index: 5000;
            flex-shrink: 0;
            height: 100vh;
            border-right: 1px solid var(--border);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center; 
            gap: 12px;
            color: var(--primary);
        }

        .nav-links {
            flex: 1;
            padding: 1rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 1rem;
            gap: 14px;
            text-decoration: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-item:hover { background: var(--background); color: var(--text-main); }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* --- Content Area --- */
        #main-content {
            flex: 1;
            padding: 2rem 3rem;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .mobile-header {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-main);
            padding: 0 1.25rem;
            height: 65px;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 3000;
            width: 100%;
            border-bottom: 1px solid var(--border);
        }

        /* --- Dashboard UI --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; width: 4px;
            background: var(--accent);
            border-radius: 4px 0 0 4px;
        }

        .stat-card h3 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .alerts-container { margin-bottom: 2rem; }
        .alert-item {
            background: white;
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-left: 4px solid var(--warning);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            border-left-width: 4px;
        }

        /* --- Components --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .card-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            min-width: 600px;
        }

        th {
            background: #fafafa;
            padding: 1rem 1.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
            color: var(--text-main);
            vertical-align: middle;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }

        .badge {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 6000;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 24px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal h2 { margin-bottom: 1.5rem; color: var(--primary); font-size: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        .form-control { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 1rem; background: var(--background); color: var(--text-main); }

        /* --- VISTA MÓVIL (Menú Inferior Nativo y Corrección de Scroll Horizontal) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-x: hidden; }
            
            /* Ocultar elementos del menú lateral que no van abajo */
            .sidebar-header, #sidebar > div:last-child {
                display: none !important;
            }
            
            /* Convertir Sidebar en Barra de Navegación Inferior */
            #sidebar { 
                position: fixed; 
                left: 0; 
                bottom: 0; 
                top: auto;
                height: 75px; 
                width: 100%;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--border);
                box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
                padding: 0;
            }
            
            .nav-links {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                padding: 0;
                width: 100%;
            }

            .nav-item {
                flex-direction: column;
                gap: 4px;
                padding: 8px 4px;
                font-size: 0.65rem;
                justify-content: center;
                border-radius: 8px;
                width: 20%;
                text-align: center;
            }

            .nav-item i { width: 22px; height: 22px; }
            .nav-item.active { background: transparent; color: var(--accent); box-shadow: none; font-weight: 800; }
            .nav-item.active i { color: var(--accent); fill: rgba(79, 70, 229, 0.1); }
            
            .mobile-header { display: flex; }
            
            /* Padding inferior para que el menú no tape el contenido */
            #main-content { padding: 1.5rem 1rem 90px 1rem; width: 100%; box-sizing: border-box; }
            
            .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .page-header .btn { width: 100%; }
            .header-actions { display: flex; width: 100%; gap: 10px; flex-wrap: wrap; }
            .header-actions .btn { flex: 1; justify-content: center; min-width: 100px; }

            .stats-grid { grid-template-columns: 1fr; gap: 1rem; }

            /* --- Transformar Tablas en Tarjetas (CORRECCIÓN SCROLL HORIZONTAL) --- */
            .table-container { overflow-x: hidden; } /* Prevenir scroll horizontal heredado */
            table { min-width: 100% !important; width: 100%; } /* Evitar que fuerce los 600px */
            table, thead, tbody, th, td, tr { display: block; width: 100%; box-sizing: border-box; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr { 
                background: white;
                border: 1px solid var(--border); 
                margin-bottom: 1rem; 
                border-radius: 16px; 
                padding: 1rem; 
                box-shadow: var(--shadow-sm);
            }
            
            td { 
                border: none; 
                padding: 0.6rem 0 !important; 
                display: flex; 
                align-items: center; 
                justify-content: space-between; 
                text-align: right; 
                border-bottom: 1px solid #f1f5f9;
                word-break: break-word;
                gap: 15px;
            }
            
            td:before { 
                content: attr(data-label); 
                font-weight: 600; 
                color: var(--text-muted); 
                font-size: 0.8rem; 
                text-transform: uppercase; 
                text-align: left; 
                flex-shrink: 0;
                max-width: 45%;
            }

            td:last-child { 
                border-bottom: none; 
                padding-top: 1rem !important; 
                margin-top: 0.5rem;
                justify-content: flex-end; 
                gap: 10px;
            }
            
            .modal { padding: 1.5rem; border-radius: 20px; }
        }

        .hidden { display: none !important; }
        section { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- Auth Overlay -->
    <div id="auth-overlay">
        <div class="auth-card">
            <div style="width: 64px; height: 64px; background: #e0e7ff; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i data-lucide="building-2" style="width:32px; height:32px; color:var(--accent);"></i>
            </div>
            <h2 style="color:var(--primary); font-weight:800; font-size:1.5rem;">Propify</h2>
            <p style="margin-bottom: 2rem; color: var(--text-muted); font-size:0.9rem;">Gestión Residencial</p>
            <input type="password" id="auth-pass" class="form-control" placeholder="Clave (Default: 1234)" style="margin-bottom: 1.5rem; text-align: center; font-size:1.1rem; letter-spacing: 2px;">
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="checkAuth()">Acceder</button>
        </div>
    </div>

    <!-- Mobile Header (Top Bar) -->
    <div class="mobile-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <i data-lucide="home" style="width:24px; color:var(--accent);"></i>
            <strong style="font-size: 1.2rem; letter-spacing: -0.5px;">Propify</strong>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" style="padding: 8px; border:none;" onclick="exportDataJSON()" title="Descargar Backup"><i data-lucide="download"></i></button>
            <button class="btn btn-ghost" style="padding: 8px; border:none; color:var(--danger);" onclick="logout()" title="Cerrar Sesión"><i data-lucide="log-out"></i></button>
        </div>
    </div>

    <!-- Sidebar / Bottom Nav en Móvil -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <div style="background: var(--accent); padding: 8px; border-radius: 10px; display:flex;">
                <i data-lucide="home" style="color:white; width: 20px; height: 20px;"></i>
            </div>
            Propify
        </div>
        <nav class="nav-links">
            <a class="nav-item active" onclick="navigate('dashboard')"><i data-lucide="layout-grid"></i> <span>Dashboard</span></a>
            <a class="nav-item" onclick="navigate('tenants')"><i data-lucide="users"></i> <span>Inquilinos</span></a>
            <a class="nav-item" onclick="navigate('payments')"><i data-lucide="wallet"></i> <span>Recaudos</span></a>
            <a class="nav-item" onclick="navigate('services')"><i data-lucide="zap"></i> <span>Servicios</span></a>
            <a class="nav-item" onclick="navigate('adminfees')"><i data-lucide="building"></i> <span>Admin</span></a>
        </nav>
        <div style="padding: 1.5rem; border-top: 1px solid var(--border);">
            <button class="btn btn-ghost" onclick="exportDataJSON()" style="width: 100%; margin-bottom: 10px; justify-content:center;">
                <i data-lucide="download" style="width:16px;"></i> Backup Data
            </button>
            <button class="btn btn-ghost" onclick="logout()" style="width: 100%; color: var(--danger); justify-content:center;">
                <i data-lucide="log-out" style="width:16px;"></i> Salir
            </button>
        </div>
    </aside>

    <main id="main-content">
        <!-- Dashboard Section -->
        <section id="view-dashboard">
            <div class="page-header">
                <h1>Resumen de Gestión</h1>
            </div>

            <div id="dashboard-alerts" class="alerts-container"></div>

            <div class="stats-grid">
                <div class="stat-card"><h3>Total Inquilinos</h3><div class="value" id="stat-tenants">0</div></div>
                <div class="stat-card" style="border-left-color: var(--success);"><h3>Recaudado Mes</h3><div class="value" id="stat-monthly">0</div></div>
                <div class="stat-card" style="border-left-color: var(--danger);"><h3>Mora Inquilinos</h3><div class="value" id="stat-debt">0</div></div>
                
                <!-- Tarjeta Admin Modificada -->
                <div class="stat-card" style="border-left-color: var(--warning);">
                    <h3 id="admin-stat-title">Admin Pagada (Año)</h3>
                    <div class="value" id="stat-admin-count">0/12</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;" id="stat-admin-debt">Deuda: $0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Últimos Movimientos</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha Registro</th><th>Inquilino</th><th>Concepto</th><th>Monto</th><th>Acciones</th></tr></thead>
                        <tbody id="recent-payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tenants Section -->
        <section id="view-tenants" class="hidden">
            <div class="page-header">
                <h1>Directorio de Inquilinos</h1>
                <button class="btn btn-primary" onclick="openTenantModal()"><i data-lucide="plus"></i> Nuevo Inquilino</button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Nombre</th><th>WhatsApp</th><th>Canon</th><th>Vencimiento</th><th>Acciones</th></tr></thead>
                        <tbody id="tenants-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payments Section -->
        <section id="view-payments" class="hidden">
            <div class="page-header">
                <h1>Pagos Recibidos</h1>
                <button class="btn btn-success" onclick="openPaymentModal()"><i data-lucide="plus"></i> Registrar Abono</button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha Registro</th><th>Inquilino</th><th>Concepto</th><th>Monto</th><th>Mes Aplicado</th><th>Acciones</th></tr></thead>
                        <tbody id="payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section id="view-services" class="hidden">
            <div class="page-header">
                <h1>Gestión de Servicios</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openUtilityModal()"><i data-lucide="plus-circle"></i> Maestro</button>
                    <button class="btn btn-ghost" onclick="openReadingModal()"><i data-lucide="file-digit"></i> Lectura</button>
                    <button class="btn btn-success" onclick="openServicePaymentModal()"><i data-lucide="credit-card"></i> Cobrar Inq.</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>Cuentas Maestras</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Servicio</th><th>NIC / Contrato</th><th>Vencimiento</th><th>Acciones</th></tr></thead>
                        <tbody id="utility-accounts-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>Registro de Medidores</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha</th><th>Servicio</th><th>Inquilino</th><th>Lectura</th><th>Acciones</th></tr></thead>
                        <tbody id="services-readings-tbody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><h2>Pagos de Servicios (Inquilinos)</h2></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Fecha</th><th>Servicio</th><th>Inquilino</th><th>Monto</th><th>Mes/Año</th><th>Acciones</th></tr></thead>
                        <tbody id="services-payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Admin Fees Section -->
        <section id="view-adminfees" class="hidden">
            <div class="page-header">
                <h1>Administración</h1>
                <button class="btn btn-primary" onclick="openAdminModal()"><i data-lucide="plus"></i> Registro Manual</button>
            </div>
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead><tr><th>Registro</th><th>Mes/Año</th><th>Valor</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody id="adminfees-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="tenant-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="t-modal-title">Ficha del Inquilino</h2>
            <form id="tenant-form" onsubmit="handleTenantSubmit(event)">
                <input type="hidden" id="t-id-hidden">
                <div class="form-group"><label>Nombre Completo</label><input type="text" id="t-name" class="form-control" required></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group"><label>WhatsApp</label><input type="tel" id="t-phone" class="form-control"></div>
                    <div class="form-group"><label>Día de Pago</label><input type="number" id="t-payday" class="form-control" min="1" max="31"></div>
                </div>
                <div class="form-group"><label>Canon Mensual ($)</label><input type="number" id="t-rent" class="form-control" required></div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group"><label>Inicio Contrato</label><input type="date" id="t-start" class="form-control" required></div>
                    <div class="form-group"><label>Fin Contrato</label><input type="date" id="t-end" class="form-control" required></div>
                </div>

                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PAGO DE INQUILINOS CON CAMPO CONCEPTO RESTAURADO -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="p-modal-title">Registrar Abono</h2>
            <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
                <div class="form-group"><label>Inquilino</label><select id="p-tenant" class="form-control" required></select></div>
                
                <div class="form-group">
                    <label>Concepto</label>
                    <select id="p-concept" class="form-control" required>
                        <option value="Arriendo Mensual">Arriendo Mensual</option>
                        <option value="Fracción">Fracción</option>
                        <option value="Depósito">Depósito</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group"><label>Monto Pagado ($)</label><input type="number" id="p-amount" class="form-control" required></div>
                <div class="form-group"><label>Mes a aplicar</label><input type="month" id="p-month" class="form-control" required></div>
                <div class="form-group"><label>Soporte (Foto/Recibo)</label><input type="file" id="p-file" class="form-control" accept="image/*" style="padding: 10px;"></div>
                
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex:1; padding: 14px;">Guardar Abono</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="utility-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="u-modal-title">Cuenta Maestra</h2>
            <form id="utility-form" onsubmit="handleUtilitySubmit(event)">
                <input type="hidden" id="u-id-hidden">
                <div class="form-group"><label>Empresa Proveedora</label><select id="u-type" class="form-control"><option>Afinia</option><option>Surtigas</option><option>Aguas de Cartagena</option></select></div>
                <div class="form-group"><label>NIC / Contrato</label><input type="text" id="u-contract" class="form-control" required></div>
                <div class="form-group"><label>Día de Vencimiento</label><input type="text" id="u-due-date" class="form-control" placeholder="Ej: 04 de cada mes"></div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Cuenta</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reading-modal" class="modal-overlay">
        <div class="modal">
            <h2>Registrar Lectura</h2>
            <form id="reading-form" onsubmit="handleReadingSubmit(event)">
                <div class="form-group"><label>Inquilino</label><select id="r-tenant" class="form-control" required></select></div>
                <div class="form-group"><label>Servicio</label><select id="r-type" class="form-control"><option>Luz</option><option>Agua</option><option>Gas</option></select></div>
                <div class="form-group"><label>Lectura Actual (Números)</label><input type="number" id="r-meter" class="form-control" required step="any"></div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Lectura</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="service-payment-modal" class="modal-overlay">
        <div class="modal">
            <h2>Cobrar Servicio</h2>
            <form id="service-payment-form" onsubmit="handleServicePaymentSubmit(event)">
                <div class="form-group"><label>Inquilino</label><select id="sp-tenant" class="form-control" required></select></div>
                <div class="form-group"><label>Servicio Facturado</label><select id="sp-type" class="form-control"><option>Luz</option><option>Agua</option><option>Gas</option></select></div>
                <div class="form-group"><label>Monto a Cobrar ($)</label><input type="number" id="sp-amount" class="form-control" required></div>
                <div class="form-group"><label>Mes Correspondiente</label><input type="month" id="sp-month" class="form-control" required></div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex:1; padding: 14px;">Guardar Cobro</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay">
        <div class="modal">
            <h2>Cuota Administración</h2>
            <form id="admin-form" onsubmit="handleAdminSubmit(event)">
                <input type="hidden" id="a-id-hidden">
                <div class="form-group"><label>Mes/Año</label><input type="month" id="a-month" class="form-control" required></div>
                <div class="form-group"><label>Monto ($)</label><input type="number" id="a-amount" class="form-control" required></div>
                <div class="form-group"><label>Estado</label>
                    <select id="a-status" class="form-control">
                        <option value="Pagado">Pagado</option>
                        <option value="Pendiente">Pendiente</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary" style="flex:1; padding: 14px;">Guardar Estado</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModals()" style="flex:1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewer-modal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                <h3 style="margin:0; font-size:1.2rem;">Soporte del Pago</h3>
                <button type="button" class="btn btn-ghost" onclick="closeModals()" style="padding: 8px; border:none;"><i data-lucide="x"></i></button>
            </div>
            <div style="text-align:center; min-height: 250px; background:var(--background); border-radius:16px; overflow:hidden; display:flex; align-items:center; justify-content:center; border: 1px solid var(--border);">
                <img id="viewer-img" src="" style="max-width:100%; max-height: 60vh; display:none; border-radius: 12px;">
                <div id="viewer-empty" style="color: var(--text-muted); display:flex; flex-direction:column; align-items:center; gap:10px;">
                    <i data-lucide="image-off" style="width:32px; height:32px;"></i>
                    <p>Sin imagen adjunta.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 7000;">
        <div class="modal" style="max-width: 350px; text-align: center; padding: 2.5rem 1.5rem;">
            <div style="width: 64px; height: 64px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i data-lucide="alert-triangle" style="width:32px; height:32px; color:var(--danger);"></i>
            </div>
            <h3 style="font-size: 1.3rem;">¿Estás seguro?</h3>
            <p id="confirm-text" style="margin: 0.8rem 0 2rem; color: var(--text-muted); font-size: 0.95rem;">Esta acción no se puede deshacer.</p>
            <div style="display: flex; gap: 10px;">
                <button id="confirm-yes" class="btn btn-danger" style="flex: 1; padding: 14px;">Eliminar</button>
                <button onclick="closeConfirm()" class="btn btn-ghost" style="flex: 1; padding: 14px;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    // --- 1. CONFIGURACIÓN LOCAL INDEXED DB ---
    const DB_NAME = 'PropifyLocalDB';
    const STORE_NAME = 'mainData';
    let db;

    // CONFIGURACIÓN NUBE (GITHUB GIST)
    const GIST_ID = 'd2c6ca2ad6ad9b41a96bfc58e8d9a637';
    const GITHUB_TOKEN = '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';
    const CLOUD_FILENAME = "propify_backup_local_2026-02-22 (2).json";

    async function initDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(DB_NAME, 2);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
            };
            request.onsuccess = (e) => { db = e.target.result; resolve(); };
        });
    }

    async function getData() {
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get('main');
            req.onsuccess = () => {
                let d = req.result || { tenants: [], payments: [], services: [], servicePayments: [], adminfees: [], utilityAccounts: [] };
                // Asegurar arreglos
                ['tenants', 'payments', 'services', 'servicePayments', 'adminfees', 'utilityAccounts'].forEach(k => {
                    if (!d[k]) d[k] = [];
                });
                resolve(d);
            };
        });
    }

    async function saveData(data) {
        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(data, 'main');
            tx.oncomplete = () => resolve();
        });
    }

    // --- FUNCIONES DE NUBE ---
    async function syncToCloud() {
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    files: { [CLOUD_FILENAME]: { content: JSON.stringify(state, null, 2) } }
                })
            });
            if (response.ok) console.log("Sincronizado con GitHub");
        } catch (error) {
            console.error("Error nube:", error);
        }
    }

    async function loadFromCloud() {
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);
            if (!response.ok) return;
            const gist = await response.json();
            if (gist.files && gist.files[CLOUD_FILENAME]) {
                const content = JSON.parse(gist.files[CLOUD_FILENAME].content);
                if (content && Object.keys(content).length > 0) {
                    state = content;
                    await saveData(state);
                    console.log("Datos descargados");
                }
            }
        } catch (error) {
            console.error("Error carga nube:", error);
        }
    }

    // --- 3. ESTADO Y CONTROLADORES ---
    let state = { tenants: [], payments: [], services: [], servicePayments: [], adminfees: [], utilityAccounts: [] };

    async function sync() {
        state = await getData();
        renderAll();
    }

    // FUNCIÓN DE ACCESO CORREGIDA
    async function checkAuth() {
        const pass = document.getElementById('auth-pass').value;
        if (pass === '1234') {
            document.getElementById('auth-overlay').style.display = 'none';
            sessionStorage.setItem('authed', 'true');
            
            // Primero mostramos lo que tengamos localmente para que sea instantáneo
            await sync();
            
            // Luego intentamos actualizar desde la nube en segundo plano
            loadFromCloud().then(() => sync());
        } else {
            alert('Clave incorrecta');
        }
    }

    function logout() { sessionStorage.removeItem('authed'); location.reload(); }

    function navigate(view) {
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if (window.event) window.event.currentTarget.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closeModals() { 
        document.querySelectorAll('.modal-overlay').forEach(m => { if(m.id !== 'confirm-modal') m.style.display = 'none'; }); 
    }

    // --- RENDERIZADO Y FORMULARIOS (Simplificado para el ejemplo, mantén tus funciones de renderizado originales) ---
    // Nota: Asegúrate de que tus funciones handle...Submit llamen a await syncToCloud() al final.

    async function handleTenantSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('t-id-hidden').value;
        const data = { id: id || Date.now().toString(), name: document.getElementById('t-name').value, phone: document.getElementById('t-phone').value, payday: document.getElementById('t-payday').value, rent: document.getElementById('t-rent').value, start: document.getElementById('t-start').value, end: document.getElementById('t-end').value };
        if (id) { const idx = state.tenants.findIndex(x => x.id == id); state.tenants[idx] = data; } else state.tenants.push(data);
        await saveData(state); 
        sync(); 
        closeModals();
        syncToCloud(); // Se dispara sin 'await' para no bloquear la UI
    }

    // ... (Mantén el resto de tus funciones de renderizado igual que en tu archivo original) ...

    // --- INICIO DE APLICACIÓN ---
    window.onload = async () => {
        try {
            await initDB();
            if (sessionStorage.getItem('authed')) {
                document.getElementById('auth-overlay').style.display = 'none';
                await sync();
                loadFromCloud().then(() => sync());
            }
        } catch (e) {
            console.error("Error inicio:", e);
        }
    };
</script>
</body>
</html>
